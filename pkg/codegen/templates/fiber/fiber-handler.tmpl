// FiberServerOptions provides options for the Fiber server.
type FiberServerOptions struct {
    BaseURL string
    Middlewares []MiddlewareFunc
}

// RegisterHandlers creates http.Handler with routing matching OpenAPI spec.
func RegisterHandlers(router fiber.Router, si ServerInterface) {
  RegisterHandlersWithOptions(router, si, FiberServerOptions{})
}

// RegisterHandlersWithOptions creates http.Handler with additional options
func RegisterHandlersWithOptions(router fiber.Router, si ServerInterface, options FiberServerOptions) {
{{if .}}wrapper := ServerInterfaceWrapper{
Handler: si,
}

for _, m := range options.Middlewares {
    router.Use(fiber.Handler(m))
}
{{end}}
{{range .}}
router.{{.Method | lower | title }}(options.BaseURL+"{{.Path | swaggerUriToFiberUri}}", wrapper.{{.OperationId}})
{{end}}
}

// RegisterHandlerVersions - creates http.Handler with routing matching OpenAPI spec.
func RegisterHandlerVersions(
     router fiber.Router, 
     si ServerInterface, 
     version string,
     apiHandlers map[string]map[string]fiber.Handler) map[string]map[string]fiber.Handler {
  return RegisterHandlerVersionsWithOptions(router, si, version, apiHandlers, FiberServerOptions{})
}

// RegisterHandlerVersionsWithOptions - creates http.Handler with routing matching OpenAPI spec.
func RegisterHandlerVersionsWithOptions(
  router fiber.Router, 
  si ServerInterface, 
  version string, 
	apiHandlers map[string]map[string]fiber.Handler, 
  options FiberServerOptions) map[string]map[string]fiber.Handler {

    var wrapper = ServerInterfaceWrapper{
        Handler: si,
    }
    for _, m := range options.Middlewares {
      router.Use(fiber.Handler(m))
    }
  
    if apiHandlers == nil {
      apiHandlers = make(map[string]map[string]fiber.Handler)
    }
    {{$lastPath := ""}}
    var versionedPath, latestPath string
    {{range .}}
    {{$currentPath := .Path | swaggerUriToFiberUri}}
    {{if ne $lastPath $currentPath}}
    {{if ne $lastPath ""}}

    {{end}}
    // {{.Path}}
    versionedPath = "/" + version + "{{$currentPath}}"
    if apiHandlers[versionedPath] == nil {
        apiHandlers[versionedPath] = make(map[string]fiber.Handler)
    }

    latestPath = "/" + fibermid.LatestVersion + "{{$currentPath}}"
    if apiHandlers[latestPath] == nil {
        apiHandlers[latestPath] = make(map[string]fiber.Handler)
    }
    {{$lastPath = $currentPath}}
    {{end}}
    apiHandlers[versionedPath]["{{.Method}}"] = wrapper.{{.OperationId}}
    apiHandlers[latestPath]["{{.Method}}"] = wrapper.{{.OperationId}}
    {{end}}
    return apiHandlers
}
